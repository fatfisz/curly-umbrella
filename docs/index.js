"use strict";function t(t){w=60/t/4,g=m.currentTime,b=0}function e(){b%4==3&&(g=m.currentTime+w),b+=1}function n(){if(null===g)return null;const t=1-Math.abs((g-m.currentTime)/w);return Math.max(Math.min(t,1),0)**2}function a(t,e){return[P*t,B*e]}function s(t){return P*t}function r(t){return B*t}function o(){P=window.innerWidth,B=window.innerHeight,P=Math.min(P,Math.floor(innerHeight*k)),B=Math.min(B,Math.floor(P/k)),d.width=P,d.height=B}function i(t,e){const n=M.width*t/5,a=M.height*t/5;y.restore(),y.save(),y.translate(s(C),r(R)),y.rotate(e),y.drawImage(M,-n/2,-r(t)-a,n,a)}function l(t=0){requestAnimationFrame(l),A&&(A=!1,o());const e=t/2e4,s=S+n()/100;y.restore(),y.save(),y.fillStyle="#BBF3FC",y.fillRect(0,0,...a(1,1)),y.beginPath(),y.fillStyle="#8BE075",y.arc(...a(C,R),r(s),0,v),y.fill();for(let t=0;t<128;++t)i(s,v*t/128-e)}function c(){for(let t=0;t<D-1;t++){const e=E[t]&I|E[(t+1)%D]&T;E[t]=E[(t+x)%D]^e>>>1,e%2!=0&&(E[t]^=F)}}function h(){0===H&&c();let t=E[H];return t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,t^=t>>>18,H=(H+1)%D,(t>>>0)/4294967296}function u(t,e){function n(){c=100/(e[5]*e[5]+.001),u=100/(e[6]*e[6]+.001),p=1-e[7]*e[7]*e[7]*.01,f=-e[8]*e[8]*e[8]*1e-6,e[0]||(b=.5-e[13]/2,d=5e-5*-e[14]),m=1+e[11]*e[11]*(e[11]>0?-.9:10),w=0,g=1==e[12]?0:(1-e[12])*(1-e[12])*2e4+32}var a,s,r;for(a=0;a<24;a++)e[a]=e[a]||0;e[2]<.01&&(e[2]=.01),(s=e[1]+e[2]+e[4])<.18&&(r=.18/s,e[1]*=r,e[2]*=r,e[4]*=r);var o,i,l,c,u,p,f,m,w,g,b,d,y,v,k;if(n(),o=e[1]*e[1]*1e5,i=e[2]*e[2]*1e5,l=e[4]*e[4]*1e5+12,y=3*((o+i+l)/3|0),v={buffer:null,rawData:new Float32Array(y)},function(t,a){var s=1!=e[18]||e[21],r=e[21]*e[21]*.1,y=1+3e-4*e[22],v=e[18]*e[18]*e[18]*.1,k=1+1e-4*e[19],P=1!=e[18],B=e[23]*e[23],A=e[6],M=e[16]||e[17],C=e[17]*e[17]*e[17]*.2,R=e[16]*e[16]*(e[16]<0?-1020:1020),S=e[15]?32+((1-e[15])*(1-e[15])*2e4|0):0,D=e[3],x=e[9]/2,I=e[10]*e[10]*.01,T=e[0],F=o,E=1/o,H=1/i,z=1/l,N=5/(1+e[20]*e[20]*20)*(.01+v);N>.8&&(N=.8),N=1-N;for(var V,j,q,U,W,$,G=0,J=0,K=0,L=0,O=0,Q=0,X=0,Y=0,Z=0,_=0,tt=0,et=new Array(1024),nt=new Array(32),at=et.length;at--;)et[at]=0;for(at=nt.length;at--;)nt[at]=2*h()-1;for(at=0;at<a;at++){if(G)return at;if(S&&++_>=S&&(_=0,n()),g&&++w>=g&&(g=0,c*=m),p+=f,(c*=p)>u&&(c=u,A>0&&(G=!0)),j=c,x>0&&(tt+=I,j*=1+Math.sin(tt)*x),(j|=0)<8&&(j=8),T||((b+=d)<0?b=0:b>.5&&(b=.5)),++K>F)switch(K=0,++J){case 1:F=i;break;case 2:F=l}switch(J){case 0:L=K*E;break;case 1:L=1+2*(1-K*H)*D;break;case 2:L=1-K*z;break;case 3:L=0,G=!0}M&&((q=0|(R+=C))<0?q=-q:q>1023&&(q=1023)),s&&y&&((r*=y)<1e-5?r=1e-5:r>.1&&(r=.1)),$=0;for(var st=8;st--;){if(++Y>=j&&(Y%=j,3==T))for(var rt=nt.length;rt--;)nt[rt]=2*h()-1;switch(T){case 0:W=Y/j<b?.5:-.5;break;case 1:W=1-Y/j*2;break;case 2:W=.225*(((W=1.27323954*(U=6.28318531*((U=Y/j)>.5?U-1:U))+.405284735*U*U*(U<0?1:-1))<0?-1:1)*W*W-W)+W;break;case 3:W=nt[Math.abs(32*Y/j|0)]}s&&(V=X,(v*=k)<0?v=0:v>.1&&(v=.1),P?(Q+=(W-X)*v,Q*=N):(X=W,Q=0),O+=(X+=Q)-V,W=O*=1-r),M&&(et[Z%1024]=W,W+=et[(Z-q+1024)%1024],Z++),$+=W}$*=.125*L*B,t[at]=$>=1?1:$<=-1?-1:$}}(v.rawData,y),v.buffer=t.createBuffer(1,y,44100),"copyToChannel"in v.buffer)v.buffer.copyToChannel(v.rawData,0);else for(k=v.buffer.getChannelData(0),a=0;a<y;a++)k[a]=v.rawData[a];return v}function p(t){const e=7680-64*t;return 8363*Math.pow(2,(4608-e)/768)}function f(){this.data=null,this.position=0,this.playbackRate=0}var m=new AudioContext;let w=null,g=null,b=0;const d=document.getElementById("canvas"),y=d.getContext("2d"),v=2*Math.PI,k=1.5;let P,B,A=!0;const M=function(t){const e=new Image;return e.src=`data:image/svg+xml;utf8,${encodeURIComponent(t)}`,e}(`\n  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 41 56">\n    <path fill="none" stroke-width="2" stroke="#000" d="M15.5 50.5v5h10v-5m-5-50l20 50H.5z" opacity=".3" stroke-linejoin="round" stroke-dasharray="4 1.5"/>\n  </svg>\n`),C=.2,R=6,S=5.2;window.onresize=(()=>{A=!0});const D=624,x=397,I=2147483648,T=2147483647,F=2567483615,E=[42];for(let t=1;t<D;t++){const e=E[t-1]^E[t-1]>>>30;E[t]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+t,E[t]>>>=0}let H=0;class z{constructor(t){const{buffer:e,rawData:n}=u(m,t);this.buffer=e,this.rawData=n}}class N{constructor(t){this.data=t.rawData}init(){this.position=0,this.playbackRate=0}}class V{constructor({bpm:t,channels:e,startAt:n=0,loopAt:a=0}){const s=e[0],r=s.notes.length,o=s.patterns.length;for(let t=0;t<e.length;++t){const n=e[t];n.sample=new N(n.sample)}this.bpm=t,this.channels=e,this.startAt=n,this.loopAt=a,this.notesPerPattern=r,this.patternsPerChannel=o,this.samplesPerBar=Math.round(60*m.sampleRate/(4*t)),this.sampleRatio=44100/m.sampleRate}init(){this.bufferPosition=0,this.currentPattern=this.startAt,this.currentBar=0;for(const{sample:t}of this.channels)t.init();return this}}const j=new z([3,,.11,.49,.34,.05,,-.24,.2,,,-1,,.45,.16,,,,.55,-.75,,,,.6]),q=new z([3,,.05,.35,.03,.5,,,,,,-1,,.45,.16,,,,1,,,,,.27]),U=new z([3,,.25,.49,.34,.25,,,,,,-1,,.45,.16,,,,1,,,,,.33]),W=new z([0,,.16,,.16,.19,,.02,-.02,.07,1,-1,,,-.02,.01,,,1,,,,,.43]),$=new z([0,.04,.4,.5497,.1838,.27,,,,,,,,,,,,,1,,,,,.45]),G=new z([1,,.1341,,.1196,.382,,,,,,,,.0303,,,,,1,,,.1,,.3]);var J={level1:new V({bpm:133,channels:[{sample:j,patterns:[1,1,1,1,1,1,1,1],notes:[61,,,,61,,,,61,,,,61,,,,61,,,,61,,,,61,,,,61,,,,]},{sample:q,patterns:[1,1,1,1,1,1,1,1],notes:[,,61,,,,61,61,,,61,,,,61,61,,,61,,,,61,61,,,61,,,,61,61]},{sample:U,patterns:[1,1,1,1,1,1,1,1],notes:[,,,,61,,,,,,,,61,,,,,,,,61,,,,,,,,61]},{sample:U,patterns:[,1,,,,,,],notes:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,61,61,61]},{sample:U,patterns:[,,,1,,1,,1],notes:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,65]},{sample:W,patterns:[,,1,1,1,1,,],notes:[0,,44,44,0,,44,44,0,,44,44,0,,44,44,0,,42,42,0,,42,42,0,,42,42,0,,42,42]},{sample:W,patterns:[,,1,1,1,1,,],notes:[0,,51,51,0,,51,51,0,,51,51,0,,51,51,0,,49,49,0,,49,49,0,,49,49,0,,49,49]},{sample:W,patterns:[,,,,,,1],notes:[0,,44,44,0,,44,44,0,,44,44,0,,44,44,0,,44,44,0,,44,44,0,,44,44,0,,44,44]},{sample:W,patterns:[,,,,,,1],notes:[0,,49,49,0,,49,49,0,,49,49,0,,49,49,0,,51,51,0,,51,51,0,,51,51,0,,51,51]},{sample:W,patterns:[,,,,,,,1],notes:[0,,42,42,0,,42,42,0,,42,42,0,,42,42,0,,44,44,0,,44,44,0,,44,44,0,,44,44]},{sample:W,patterns:[,,,,,,,1],notes:[0,,49,49,0,,49,49,0,,49,49,0,,49,49,0,,51,51,0,,51,51,0,,51,51,0,,51,51]},{sample:$,patterns:[,,1,,1,,,],notes:[68,,,,63,,,,,,63,,,,68,,66,,65,,66,,63,,,,63,,61]},{sample:$,patterns:[,,,1,,1,,],notes:[60,,,,56,,,,,,56,,60,,56,,54,,61,,63,,65,,,,65,,63]},{sample:$,patterns:[,,,,,1,,],notes:[,61,60,0]},{sample:$,patterns:[,,,,,,1],notes:[61,,,,68,,65,,,,61,,,,61,,56,,63,,61,,60,,,,56,,58,,60]},{sample:$,patterns:[,,,,,,,1],notes:[66,,54,,65,,54,,63,,54,,61,,54,,60,,61,,63,,56]},{sample:G,patterns:[,,1,1,1,1,,],notes:[44,48,51,56,51,56,60,63,60,56,60,56,51,56,51,48,42,48,51,54,51,54,60,63,60,54,60,54,51,54,51,48]},{sample:G,patterns:[,,,,,,1],notes:[41,44,49,53,49,53,56,61,56,53,56,53,49,53,49,44,44,48,51,56,51,56,60,63,60,56,60,56,51,56,51,48]},{sample:G,patterns:[,,,,,,,1],notes:[42,46,49,54,49,54,58,61,58,54,58,54,49,54,49,46,44,48,51,56,51,56,60,63,60,56,60,56,51,56,51,48]}],loopAt:2})};class K{constructor(){this.songVolume=.35,this.currentSong=null,this.synthChannels=[];for(let t=0;t<24;++t)this.synthChannels[t]=new f;const t=m.createScriptProcessor(1024,0,1);t.onaudioprocess=this.fillAudioNodeBuffer.bind(this),t.connect(m.destination)}fillAudioNodeBuffer(t){const n=t.outputBuffer.getChannelData(0);if(n.fill(0),!this.currentSong)return;const a=this.currentSong;for(let t=0;t<n.length;++t){if(a.bufferPosition%a.samplesPerBar==0){e();for(const{notes:t,patterns:e,sample:n}of a.channels){if(!e[a.currentPattern])continue;const s=t[a.currentBar];void 0!==s&&(0!==s?(n.position=0,n.playbackRate=p(s)/p(49)*a.sampleRatio):n.playbackRate=0)}a.currentBar++,a.currentBar===a.notesPerPattern&&(a.currentBar=0,a.currentPattern+=1,a.currentPattern===a.patternsPerChannel&&(a.currentPattern=a.loopAt))}let s=0;for(const{sample:t}of a.channels)0!==t.playbackRate&&(s+=t.data[Math.floor(t.position)],t.position+=t.playbackRate,t.position>=t.data.length&&(t.playbackRate=0));n[t]=s*this.songVolume,a.bufferPosition+=1}}playSong(e){const n=J[e];this.currentSong!==n&&(t(n.bpm),this.currentSong=n.init(this.synthChannels))}stop(){this.currentSong=null}}const L=new K;let O=!1;document.getElementById("canvas").onclick=function(){O?L.stop():L.playSong("level1"),O=!O},l();
